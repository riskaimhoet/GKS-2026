<!-- Language Learning Dashboard (Landscape, per-material tracking + dual progress per level) -->
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title> Korean Language Learning Dashboard </title>
<style>
  :root{
    --kblue:#003478;
    --kred:#C60C30;
    --kwhite:#ffffff;
    --card-bg:#f7f9fc;
    --muted:#666;
    --radius:12px;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{ margin:0; padding:16px; background:var(--kwhite); color:#111; }
  .container{ overflow-x:auto; white-space:nowrap; padding-bottom:20px; }
  .header{ text-align:center; margin-bottom:12px; }
  h1{ color:var(--kred); margin:6px 0; }
  h2{ color:var(--kblue); margin:6px 0; }
  /* Levels row */
  .levels-row{ display:flex; gap:18px; align-items:flex-start; margin-bottom:18px; }
  .level-card{
    display:inline-block;
    width:320px;
    vertical-align:top;
    background:linear-gradient(180deg,#fff,#f8fbff);
    border-radius:var(--radius);
    border:1px solid rgba(0,0,0,0.06);
    box-shadow:0 6px 18px rgba(3,52,120,0.06);
    padding:14px;
  }
  .level-title{ font-weight:700; color:var(--kblue); margin-bottom:8px; }
  .progress-wrap{ margin-bottom:10px; }
  .bar-bg{background:#eee;width:100%;height:14px;border-radius:10px;overflow:hidden;}
  .bar-fill{height:100%;width:0%;transition:width .5s;}
  .bar-material{ background: linear-gradient(90deg,var(--kblue), var(--kred)); }
  .bar-goal{ background: linear-gradient(90deg,var(--kred), var(--kblue)); }
  .meta{ font-size:12px; color:var(--muted); margin-top:6px; }
  /* materials list */
  .materials{ margin-top:10px; max-height:320px; overflow:auto; padding-right:6px;}
  .mat{ background:var(--card-bg); padding:8px; border-radius:8px; margin-bottom:8px; border:1px solid rgba(0,0,0,0.03);}
  .mat p{ margin:0 0 6px 0; font-weight:600; color:#222; }
  .mat .row{ display:flex; gap:8px; align-items:center; font-size:13px; }
  input[type="number"]{ width:70px; padding:6px; border-radius:6px; border:1px solid #ccc; }
  input[type="checkbox"]{ transform:scale(1.1); }
  label.small{ font-size:13px; color:#333; }
  .skill-inputs{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
  .skill-inputs input{ width:48px; font-size:12px; text-align:center; }
  .btn{ padding:6px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
  .btn-start{ background:var(--kblue); color:white; }
  .btn-stop{ background:var(--kred); color:white; }
  .timer{ font-weight:700; color:var(--kred); font-size:16px; margin-top:6px; }
  /* big area for chart and controls */
  .main-row{ display:flex; gap:22px; align-items:flex-start; margin-bottom:18px; }
  .chart-card{ width:560px; padding:16px; border-radius:var(--radius); background:#ffffff; border:1px solid rgba(0,0,0,0.06); box-shadow:0 6px 18px rgba(0,0,0,0.04); }
  .controls{ padding:12px; width:720px; border-radius:var(--radius); background:#fff; border:1px solid rgba(0,0,0,0.06); box-shadow:0 6px 18px rgba(0,0,0,0.04); }
  .flex{ display:flex; gap:10px; align-items:center; }
  .muted-box{ font-size:13px; color:var(--muted); margin-top:10px; }
  .small-note{ font-size:12px; color:var(--muted); }
  .goal-list{ margin-top:10px; }
  .goal-item{ background:#fbfbfb; padding:8px; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(0,0,0,0.03); }
  /* responsive */
  @media(max-width:1100px){ .main-row{ flex-direction:column; } .levels-row{ display:block; } .level-card{ width:94%; margin-bottom:12px; } }
</style>
</head>
<body>

<div class="header">
  <h1>üá∞üá∑ Korean Language Learning Dashboard üå∏ </h1>
  <div class="small-note">Just DO IT! Jesus, Mantel Kelelawar, and 7Dream got your back, always(„Å•Ôø£ ¬≥Ôø£)„Å•</div>
</div>

<div class="container">

  <!-- TOPIK progress row (compact bars per level) -->
  <div class="levels-row" id="levelsRow">
    <!-- Level cards generated by JS -->
  </div>

  <!-- Main row: chart + controls (skill chart, global metrics, inputs) -->
  <div class="main-row">
    <div class="chart-card">
      <h2>Skill Radar (Overall)</h2>
      <canvas id="skillRadar" width="500" height="380"></canvas>
      <div class="muted-box">Skill averages are calculated from per-material skill fields (enter per-material skill scores: 0‚Äì10).</div>
    </div>

    <div class="controls">
      <h2 style="color:var(--kblue)">Level Controls & Metrics</h2>
      <div class="flex">
        <label class="small-note">Pilih Level:</label>
        <select id="levelSelect"></select>
        <button class="btn btn-start" id="startLevelBtn">Start Level Timer</button>
        <button class="btn btn-stop" id="stopLevelBtn">Stop Timer</button>
        <div style="margin-left:auto;">
          <span class="small-note">Elapsed:</span> <span id="levelElapsed" style="font-weight:700;color:var(--kblue)">00:00:00</span>
        </div>
      </div>

      <div style="margin-top:12px;">
        <h3 style="margin:8px 0 6px 0;color:var(--kblue)">Level Metrics (manual inputs for auto-goal rules)</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div>
            <label class="small-note">Vocab known (count)</label><br>
            <input type="number" id="metric_vocab" min="0" value="0">
          </div>
          <div>
            <label class="small-note">Pages read (Hangeul)</label><br>
            <input type="number" id="metric_pages" min="0" value="0">
          </div>
          <div>
            <label class="small-note">Writing pieces</label><br>
            <input type="number" id="metric_writing" min="0" value="0">
          </div>
          <div>
            <label class="small-note">Speaking tests passed</label><br>
            <input type="number" id="metric_speaking" min="0" value="0">
          </div>
        </div>
        <div style="margin-top:8px;">
          <button class="btn" id="applyMetrics">Apply Metrics ‚Üí update Goals</button>
          <span class="small-note" style="margin-left:8px;">(Use metrics to auto-check goals like "hafal X kosa kata")</span>
        </div>
      </div>

      <div class="goal-list" id="goalListArea"></div>

      <div style="margin-top:12px;">
        <h3 style="color:var(--kblue)">Notes</h3>
        <div class="small-note">- Untuk tiap materi: masukkan nilai (0‚Äì10). Materi dianggap selesai jika nilai ‚â• threshold (default 7).<br>
        - Goals bisa otomatis tercentang oleh metric (mis. vocab known) atau manual jika bukan metric-based.<br>
        - Timer level akan berhenti otomatis saat BOTH progress (materials & goals) = 100%.</div>
      </div>
    </div>
  </div>

  <!-- Detailed per-level materials (landscape scroll) -->
  <div style="margin-top:18px;">
    <h2 style="color:var(--kblue); margin-bottom:8px;">Per-Level Materials & Evaluations</h2>
    <div id="levelsDetail" style="display:flex; gap:18px; overflow-x:auto; padding-bottom:30px;"></div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ===================================================================
   DATA: levels, materials, goals
   - Each level has: id, name, materials: [{id,title,threshold}], goals: [{id,desc,type,metricKey,target}] 
   - goal.type: 'metric' (auto via metricKey) or 'manual' (user toggles)
   - per-material we store scores & skill breakdown (grammar,vocab,listening,speaking,writing,reading)
   =================================================================== */
const levels = [
  /* Level 0 - Fundamentals (DASAR) */
  {
    id: 0, code:'FUND', name:'DASAR (Fundamentals)',
    materials: [
      {id:'d1', title:'Mengenal Sejarah', threshold:7},
      {id:'d2', title:'Mengenal Hangeul - Cara baca dan tulis', threshold:7},
      {id:'d3', title:'Mengenal Hangeul - Cara gabung huruf/suku kata', threshold:7},
      {id:'d4', title:'Latihan membaca kalimat', threshold:7},
      {id:'d5', title:'Pelafalan (Î∞úÏùå) - Perubahan bunyi batchim', threshold:7},
      {id:'d6', title:'Pelafalan - Bunyi double consonant', threshold:7},
      {id:'d7', title:'Pelafalan - Intonasi kalimat', threshold:7},
      {id:'d8', title:'Angka Korea', threshold:7},
      {id:'d9', title:'Kata Ganti orang', threshold:7},
      {id:'d10', title:'Mengenal Partikel - Partikel Dasar', threshold:7},
      {id:'d11', title:'Mengenal Partikel - Kepemilikan & Penjelas', threshold:7},
      {id:'d12', title:'Mengenal Konjugasi', threshold:7},
      {id:'d13', title:'Tingkatan Kesopanan & Honorifik', threshold:7},
      {id:'d14', title:'Mengenal Jenis-jenis Grammar - Grammar Dasar', threshold:7},
      {id:'d15', title:'Merangkai Kalimat dasar', threshold:7},
      {id:'d16', title:'1000 Kata Hafalan (awal)', threshold:7}
    ],
    goals: [
      {id:'g0-1', desc:'Baca Hangul tanpa mengeja', type:'metric', metricKey:'pages', target:1},
      {id:'g0-2', desc:'Memahami Partikel', type:'manual'},
      {id:'g0-3', desc:'Memahami tingkatan Honorifik', type:'manual'},
      {id:'g0-4', desc:'Memahami Grammar dasar', type:'manual'},
      {id:'g0-5', desc:'Dapat merangkai kalimat dasar', type:'manual'},
      {id:'g0-6', desc:'Bisa memperkenalkan diri tanpa hafalan', type:'manual'},
      {id:'g0-7', desc:'Hafal 1000 kosa kata', type:'metric', metricKey:'vocab', target:1000}
    ]
  },

  /* Level 1 - TOPIK I (Level 1) */
  {
    id: 1, code:'T1-L1', name:'TOPIK I ‚Äî Level 1',
    materials: [
      {id:'t1l1-1', title:'Grammar: Conjunctions (Penghubung Kalimat)', threshold:7},
      {id:'t1l1-2', title:'Grammar: Perbandingan & Penekanan', threshold:7},
      {id:'t1l1-3', title:'Tenses & waktu/urutan', threshold:7},
      {id:'t1l1-4', title:'Grammar: Tempat & Arah', threshold:7},
      {id:'t1l1-5', title:'+1000 Kata Hafalan (melanjutkan)', threshold:7},
      {id:'t1l1-6', title:'Temukan 10 kata baru dari konten/drakor/lirik', threshold:7}
    ],
    goals:[
      {id:'g1-1', desc:'Bisa baca 1 halaman Teks Hangul', type:'metric', metricKey:'pages', target:1},
      {id:'g1-2', desc:'Mengerti percakapan tanpa subtitle', type:'metric', metricKey:'listening', target:7},
      {id:'g1-3', desc:'Dapat merangkai keseluruhan grammar tanpa menghafal', type:'manual'},
      {id:'g1-4', desc:'Gunakan bahasa korea sehari-hari tanpa menghafal', type:'manual'},
      {id:'g1-5', desc:'Lancar mengetik menggunakan keyboard Hangeul', type:'manual'},
      {id:'g1-6', desc:'Mampu menuliskan minimal 1 karya tulis', type:'metric', metricKey:'writing', target:1},
      {id:'g1-7', desc:'Hafal 2000 kosa kata', type:'metric', metricKey:'vocab', target:2000},
      {id:'g1-8', desc:'Menemukan 10 kosa kata baru (ekstra)', type:'metric', metricKey:'newWords', target:10}
    ]
  },

  /* Level 2 - TOPIK I (Level 2) */
  {
    id: 2, code:'T1-L2', name:'TOPIK I ‚Äî Level 2',
    materials: [
      {id:'t1l2-1', title:'Grammar: Ekspresi', threshold:7},
      {id:'t1l2-2', title:'Grammar: Keinginan & Kemampuan', threshold:7},
      {id:'t1l2-3', title:'Grammar: Reason (Sebab & Akibat)', threshold:7},
      {id:'t1l2-4', title:'Grammar: Condition (Jika & Maka)', threshold:7},
      {id:'t1l2-5', title:'Grammar: Explanation (Penjelasan)', threshold:7},
      {id:'t1l2-6', title:'+1000 Kata Hafalan (lanjutan)', threshold:7},
      {id:'t1l2-7', title:'Temukan 10 kata baru dari konten/drakor/lirik', threshold:7}
    ],
    goals:[
      {id:'g2-1', desc:'Merangkai keseluruhan grammar tanpa menghafal', type:'manual'},
      {id:'g2-2', desc:'Memahami/terjemahkan teks bacaan otomatis', type:'metric', metricKey:'pages', target:3},
      {id:'g2-3', desc:'Memahami percakapan tanpa subtitle', type:'metric', metricKey:'listening', target:8},
      {id:'g2-4', desc:'Mengerti penggunaan grammar di bacaan/konten', type:'manual'},
      {id:'g2-5', desc:'Gunakan bahasa korea alami tanpa menghafal', type:'manual'},
      {id:'g2-6', desc:'Mampu menulis 1 karya (tambah)', type:'metric', metricKey:'writing', target:1},
      {id:'g2-7', desc:'Hafal 3000 kosa kata', type:'metric', metricKey:'vocab', target:3000},
      {id:'g2-8', desc:'Menemukan 10 kosa kata baru', type:'metric', metricKey:'newWords', target:10}
    ]
  },

  /* Level 3 - TOPIK II (Level 3) */
  {
    id: 3, code:'T2-L3', name:'TOPIK II ‚Äî Level 3',
    materials:[
      {id:'t2l3-1', title:'Grammar Tingkat Lanjut - pengantar', threshold:7},
      {id:'t2l3-2', title:'+1000 Kata Hafalan', threshold:7},
      {id:'t2l3-3', title:'Temukan 15 kata baru dari berita/dokumen formal', threshold:7}
    ],
    goals:[
      {id:'g3-1', desc:'Merangkai keseluruhan grammar tanpa menghafal', type:'manual'},
      {id:'g3-2', desc:'Menerjemahkan teks bacaan Hangeul dengan seksama', type:'metric', metricKey:'pages', target:5},
      {id:'g3-3', desc:'Menerjemahkan percakapan tanpa subtitle', type:'metric', metricKey:'listening', target:8},
      {id:'g3-4', desc:'Dapat mengulangi dengan seksama yang didengar', type:'metric', metricKey:'speaking', target:8},
      {id:'g3-5', desc:'Percakapan profesional tanpa menghafal', type:'manual'},
      {id:'g3-6', desc:'Mampu menulis 1 cerita pendek', type:'metric', metricKey:'writing', target:1},
      {id:'g3-7', desc:'Hafal 4000 kosa kata', type:'metric', metricKey:'vocab', target:4000}
    ]
  },

  /* Level 4 - TOPIK II (Level 4) */
  {
    id: 4, code:'T2-L4', name:'TOPIK II ‚Äî Level 4',
    materials:[
      {id:'t2l4-1', title:'Idiom', threshold:7},
      {id:'t2l4-2', title:'Dialek', threshold:7},
      {id:'t2l4-3', title:'Grammar Tingkat Lanjut', threshold:7},
      {id:'t2l4-4', title:'Temukan 15 kata baru dari berita/dokumen formal', threshold:7}
    ],
    goals:[
      {id:'g4-1', desc:'Menghafal & memahami idiom', type:'metric', metricKey:'idioms', target:50},
      {id:'g4-2', desc:'Memahami perbedaan dialek', type:'manual'},
      {id:'g4-3', desc:'Merangkai grammar tanpa menghafal', type:'manual'},
      {id:'g4-4', desc:'Fasih berbicara/menulis/mendengar', type:'metric', metricKey:'speaking', target:8},
      {id:'g4-5', desc:'Tulis 1 naskah drama/lagu', type:'metric', metricKey:'writing', target:1},
      {id:'g4-6', desc:'Hafal 5000 kosa kata', type:'metric', metricKey:'vocab', target:5000},
      {id:'g4-7', desc:'Menemukan 15 kosa kata baru', type:'metric', metricKey:'newWords', target:15}
    ]
  },

  /* Level 5 - TOPIK II (Level 5) */
  {
    id: 5, code:'T2-L5', name:'TOPIK II ‚Äî Level 5',
    materials:[
      {id:'t2l5-1', title:'Grammar Profesional', threshold:7},
      {id:'t2l5-2', title:'+1000 Kata Hafalan (akhiran)', threshold:7},
      {id:'t2l5-3', title:'Temukan 20 kata baru dari literature ilmiah', threshold:7}
    ],
    goals:[
      {id:'g5-1', desc:'Berbicara minimal 1 dialek berbeda', type:'manual'},
      {id:'g5-2', desc:'Merangkai grammar tanpa menghafal', type:'manual'},
      {id:'g5-3', desc:'Mampu mengikuti interview berbahasa Korea', type:'metric', metricKey:'speaking', target:9},
      {id:'g5-4', desc:'Tulis tulisan profesional/ilmiah', type:'metric', metricKey:'writing', target:1},
      {id:'g5-5', desc:'Hafal 6000 kosa kata', type:'metric', metricKey:'vocab', target:6000},
      {id:'g5-6', desc:'Menemukan 15 kosa kata baru', type:'metric', metricKey:'newWords', target:15}
    ]
  }
];

/* ===================================================================
   State storages: per material scores & skill breakdown; per-level timers; per-goal manual toggles
   We'll store in-memory; you can later expand to localStorage or Notion sync if needed.
   =================================================================== */
const state = {
  materials: {}, // key: materialId -> {score, grammar,vocab,listening,speaking,writing,reading}
  goalsManual: {}, // goalId -> boolean
  levelTimers: {} // levelId -> {running:boolean, startTs:number, elapsedSec:number}
};

/* init state defaults */
levels.forEach(l => {
  l.materials.forEach(m => state.materials[m.id] = {
    score: '', grammar:'', vocab:'', listening:'', speaking:'', writing:'', reading:''
  });
  l.goals.forEach(g => {
    if(g.type === 'manual') state.goalsManual[g.id] = false;
  });
  state.levelTimers[l.id] = { running:false, startTs:null, elapsedSec:0 };
});


/* ===========================
   UI GENERATION
   =========================== */
const levelsRow = document.getElementById('levelsRow');
const levelsDetail = document.getElementById('levelsDetail');
const levelSelect = document.getElementById('levelSelect');
const goalListArea = document.getElementById('goalListArea');
const levelElapsed = document.getElementById('levelElapsed');
const metric_vocab = document.getElementById('metric_vocab');
const metric_pages = document.getElementById('metric_pages');
const metric_writing = document.getElementById('metric_writing');
const metric_speaking = document.getElementById('metric_speaking');

/* create level summary cards and details */
levels.forEach(level => {
  // summary card
  const card = document.createElement('div');
  card.className = 'level-card';
  card.id = 'lvlcard-'+level.id;
  card.innerHTML = `
    <div class="level-title">${level.name}</div>
    <div class="progress-wrap"><div style="font-size:13px;color:var(--muted)">Materials</div>
      <div class="bar-bg"><div id="matBar${level.id}" class="bar-fill bar-material"></div></div>
      <div class="meta"><span id="matPct${level.id}">0%</span> completed ‚Ä¢ <span id="matDone${level.id}">0</span>/<span>${level.materials.length}</span></div>
    </div>
    <div class="progress-wrap"><div style="font-size:13px;color:var(--muted)">Goals</div>
      <div class="bar-bg"><div id="goalBar${level.id}" class="bar-fill bar-goal"></div></div>
      <div class="meta"><span id="goalPct${level.id}">0%</span> completed ‚Ä¢ <span id="goalDone${level.id}">0</span>/<span>${level.goals.length}</span></div>
    </div>
    <div style="margin-top:10px;" class="flex">
      <button class="btn btn-start" onclick="selectLevel(${level.id})">Open</button>
      <div style="margin-left:auto;font-size:12px;color:var(--muted)">Timer: <span id="cardTimer${level.id}">00:00:00</span></div>
    </div>
  `;
  levelsRow.appendChild(card);

  // detail column
  const col = document.createElement('div');
  col.className = 'level-card';
  col.id = 'levelDetail-'+level.id;
  col.style.width='420px';
  col.innerHTML = `<div class="level-title">${level.name}</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">Materials & Evaluations</div>
    <div class="materials" id="mList${level.id}"></div>
    <div style="margin-top:8px;">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">Goals</div>
      <div id="gList${level.id}"></div>
    </div>
  `;
  levelsDetail.appendChild(col);

  // select option
  const opt = document.createElement('option');
  opt.value = level.id;
  opt.textContent = level.name;
  levelSelect.appendChild(opt);
});

/* populate materials and goals lists */
levels.forEach(l => {
  const mlist = document.getElementById('mList'+l.id);
  l.materials.forEach(m => {
    // material card with fields
    const mat = document.createElement('div');
    mat.className = 'mat';
    mat.id = 'mat-'+m.id;
    mat.innerHTML = `
      <p>${m.title}</p>
      <div class="row">
        <label class="small">Nilai (0-10): <input type="number" class="scoreInput" data-mid="${m.id}" min="0" max="10" step="1" value=""></label>
        <label class="small">Threshold: <input type="number" class="thInput" data-mid="${m.id}" min="0" max="10" step="1" value="${m.threshold}"></label>
        <div style="margin-left:auto; font-size:12px; color:var(--muted)"><span id="matStatus-${m.id}">Not passed</span></div>
      </div>
      <div class="skill-inputs">
        <input type="number" placeholder="G" class="skillInput" data-mid="${m.id}" data-skill="grammar" min="0" max="10">
        <input type="number" placeholder="V" class="skillInput" data-mid="${m.id}" data-skill="vocab" min="0" max="10">
        <input type="number" placeholder="L" class="skillInput" data-mid="${m.id}" data-skill="listening" min="0" max="10">
        <input type="number" placeholder="S" class="skillInput" data-mid="${m.id}" data-skill="speaking" min="0" max="10">
        <input type="number" placeholder="W" class="skillInput" data-mid="${m.id}" data-skill="writing" min="0" max="10">
        <input type="number" placeholder="R" class="skillInput" data-mid="${m.id}" data-skill="reading" min="0" max="10">
      </div>
    `;
    mlist.appendChild(mat);
  });

  // goals list
  const glist = document.getElementById('gList'+l.id);
  l.goals.forEach(g => {
    const gn = document.createElement('div');
    gn.className = 'goal-item';
    gn.id = 'goal-'+g.id;
    if(g.type === 'manual'){
      gn.innerHTML = `<div style="font-size:13px;">${g.desc}</div><div><input type="checkbox" data-gid="${g.id}" class="goalManual"></div>`;
    } else {
      const metricLabel = g.metricKey ? ` (${g.metricKey} ‚â• ${g.target})` : '';
      gn.innerHTML = `<div style="font-size:13px;">${g.desc}${metricLabel}</div><div><span id="goalState-${g.id}" style="font-weight:700;color:var(--muted)">Not yet</span></div>`;
    }
    glist.appendChild(gn);
  });
});

/* ======================
   Event bindings for material inputs
   ====================== */
function attachMaterialEvents(){
  document.querySelectorAll('.scoreInput').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const mid = inp.dataset.mid;
      state.materials[mid].score = inp.value;
      updateAllProgress();
    });
  });
  document.querySelectorAll('.thInput').forEach(inp=>{
    inp.addEventListener('input', e=>{
      // threshold changed -> update progress
      updateAllProgress();
    });
  });
  document.querySelectorAll('.skillInput').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const mid = inp.dataset.mid, skill = inp.dataset.skill;
      state.materials[mid][skill] = inp.value;
      updateRadarChart();
    });
  });
  document.querySelectorAll('.goalManual').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const gid = cb.dataset.gid;
      state.goalsManual[gid] = cb.checked;
      updateAllProgress();
    });
  });
}
attachMaterialEvents();

/* ======================
   Progress calculation
   - materials progress: count of materials with score >= threshold
   - goals progress: for metric goals compare against inputs; manual goals check state
   - update per-level bars + card timers auto-stop if both reach 100%
   ====================== */
function updateAllProgress(){
  levels.forEach(level=>{
    // materials
    const matEls = level.materials;
    let doneMat=0;
    matEls.forEach(m=>{
      const scoreEl = document.querySelector(`.scoreInput[data-mid="${m.id}"]`);
      const thEl = document.querySelector(`.thInput[data-mid="${m.id}"]`);
      const score = scoreEl && scoreEl.value !== '' ? Number(scoreEl.value) : null;
      const threshold = thEl ? Number(thEl.value) : m.threshold;
      const passed = (score !== null && score >= threshold);
      if(passed) doneMat++;
      document.getElementById('matStatus-'+m.id).innerText = passed ? 'Passed' : 'Not passed';
      document.getElementById('matStatus-'+m.id).style.color = passed ? 'green' : 'var(--muted)';
    });
    const matPct = matEls.length ? Math.round(doneMat / matEls.length * 100) : 0;
    document.getElementById('matBar'+level.id).style.width = matPct+'%';
    document.getElementById('matPct'+level.id).innerText = matPct+'%';
    document.getElementById('matDone'+level.id).innerText = doneMat;

    // goals
    let doneGoal = 0;
    level.goals.forEach(g=>{
      let achieved = false;
      if(g.type === 'manual'){
        achieved = !!state.goalsManual[g.id];
      } else if(g.type === 'metric'){
        // read the metric inputs from controls (these are intended to apply to selected level only,
        // but to make goals global-per-level we will compare current metric inputs to the goal)
        // Note: user should select level via dropdown and click apply metrics to apply them to that level
        // We'll instead store last applied metrics per level in state.levelMetrics (lazy init)
        const lm = state.levelMetrics && state.levelMetrics[level.id] ? state.levelMetrics[level.id] : {};
        const val = lm[g.metricKey] !== undefined ? Number(lm[g.metricKey]) : 0;
        achieved = val >= g.target;
      }
      if(achieved) doneGoal++;
      const el = document.getElementById('goalState-'+g.id);
      if(el) { el.innerText = achieved ? 'Done' : 'Not yet'; el.style.color = achieved ? 'green' : 'var(--muted)'; }
    });
    const goalPct = level.goals.length ? Math.round(doneGoal / level.goals.length * 100) : 0;
    document.getElementById('goalBar'+level.id).style.width = goalPct+'%';
    document.getElementById('goalPct'+level.id).innerText = goalPct+'%';
    document.getElementById('goalDone'+level.id).innerText = doneGoal;

    // if both 100% and timer running -> auto stop
    if(matPct === 100 && goalPct === 100){
      const lt = state.levelTimers[level.id];
      if(lt && lt.running){
        stopLevelTimer(level.id);
        // optionally show notification
        alert(`Level "${level.name}" is complete! Timer stopped.`);
      }
    }
  });

  // update global radar
  updateRadarChart();
}

/* ======================
   Level metrics application (apply to selected level)
   - store metrics per level in state.levelMetrics
   - then updateAllProgress (so metric-based goals update)
   ====================== */
state.levelMetrics = {}; // levelId -> {vocab, pages, writing, speaking, newWords, idioms, listening, ...}
document.getElementById('applyMetrics').addEventListener('click', ()=>{
  const lvl = Number(levelSelect.value);
  if(!state.levelMetrics[lvl]) state.levelMetrics[lvl] = {};
  state.levelMetrics[lvl].vocab = Number(metric_vocab.value || 0);
  state.levelMetrics[lvl].pages = Number(metric_pages.value || 0);
  state.levelMetrics[lvl].writing = Number(metric_writing.value || 0);
  state.levelMetrics[lvl].speaking = Number(metric_speaking.value || 0);
  // optional keys user might need: newWords, idioms, listening
  // keep previous values if existed
  state.levelMetrics[lvl].newWords = state.levelMetrics[lvl].newWords || 0;
  state.levelMetrics[lvl].idioms = state.levelMetrics[lvl].idioms || 0;
  state.levelMetrics[lvl].listening = state.levelMetrics[lvl].listening || 0;
  updateAllProgress();
  renderGoalListForLevel(lvl);
});

/* render goal area for currently selected level (for user visibility + manual toggle) */
function renderGoalListForLevel(lvl){
  const level = levels.find(x=>x.id===lvl);
  goalListArea.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">Goals for ${level.name}</div>`;
  level.goals.forEach(g=>{
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';
    div.style.padding='6px 0';
    if(g.type==='manual'){
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!state.goalsManual[g.id];
      cb.addEventListener('change', e=>{ state.goalsManual[g.id] = cb.checked; updateAllProgress(); });
      div.innerHTML = `<div>${g.desc}</div>`; div.appendChild(cb);
    } else {
      const lm = state.levelMetrics[lvl] || {};
      const val = lm[g.metricKey] || 0;
      div.innerHTML = `<div>${g.desc} (<small>${g.metricKey} ‚â• ${g.target}</small>)</div><div style="font-weight:700;color:${val>=g.target?'green':'var(--muted)'}">${val}/${g.target}</div>`;
    }
    goalListArea.appendChild(div);
  });
}

/* selection handling */
function selectLevel(id){
  levelSelect.value = id;
  // populate metric inputs from state.levelMetrics if exist
  const lm = state.levelMetrics[id] || {};
  metric_vocab.value = lm.vocab || 0;
  metric_pages.value = lm.pages || 0;
  metric_writing.value = lm.writing || 0;
  metric_speaking.value = lm.speaking || 0;
  renderGoalListForLevel(id);
  // show elapsed
  updateLevelElapsedDisplay(id);
}

/* ======================
   Timers per level (start/stop)
   - startLevelTimer(levelId) and stopLevelTimer(levelId)
   - update UI every second for running timers
   ====================== */
let globalTimerTicker = null;
function startLevelTimer(levelId){
  const lt = state.levelTimers[levelId];
  if(lt.running) return;
  lt.running = true;
  lt.startTs = Date.now() - (lt.elapsedSec * 1000); // resume
  // if not ticking, start global ticker
  if(!globalTimerTicker){
    globalTimerTicker = setInterval(()=> {
      Object.keys(state.levelTimers).forEach(lid=>{
        if(state.levelTimers[lid].running){
          const s = Math.floor((Date.now() - state.levelTimers[lid].startTs)/1000);
          state.levelTimers[lid].elapsedSec = s;
          document.getElementById('cardTimer'+lid).innerText = formatHMS(s);
          // if this level is selected, update main elapsed
          if(Number(levelSelect.value) === Number(lid)) updateLevelElapsedDisplay(lid);
        }
      });
    }, 1000);
  }
}
function stopLevelTimer(levelId){
  const lt = state.levelTimers[levelId];
  if(!lt.running) return;
  lt.running = false;
  lt.elapsedSec = Math.floor((Date.now() - lt.startTs)/1000);
  lt.startTs = null;
  // update displays
  document.getElementById('cardTimer'+levelId).innerText = formatHMS(lt.elapsedSec);
  if(Number(levelSelect.value) === Number(levelId)) updateLevelElapsedDisplay(levelId);
}
function updateLevelElapsedDisplay(levelId){
  const s = state.levelTimers[levelId].elapsedSec || 0;
  levelElapsed.innerText = formatHMS(s);
}
function formatHMS(total){
  const h = Math.floor(total/3600), m = Math.floor((total%3600)/60), s = total%60;
  return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

/* hook buttons */
document.getElementById('startLevelBtn').addEventListener('click', ()=>{
  const lvl = Number(levelSelect.value);
  startLevelTimer(lvl);
});
document.getElementById('stopLevelBtn').addEventListener('click', ()=>{
  const lvl = Number(levelSelect.value);
  stopLevelTimer(lvl);
});

/* ======================
   Radar chart (aggregate skill averages across all materials)
   - compute average per skill across materials that have values
   - also compute per-level skill averages optionally for later
   ====================== */
const radarCtx = document.getElementById('skillRadar').getContext('2d');
const radarChart = new Chart(radarCtx, {
  type:'radar',
  data:{
    labels:['Grammar','Vocabulary','Listening','Speaking','Writing','Reading'],
    datasets:[
      { label:'Skill Avg', data:[0,0,0,0,0,0], backgroundColor:'rgba(0,52,120,0.12)', borderColor: 'var(--kblue)', borderWidth:2, pointBackgroundColor: 'var(--kred)'}
    ]
  },
  options:{
    scales:{ r: { min:0, max:10, ticks:{ stepSize:1 } } },
    plugins:{ legend:{ display:false } }
  }
});

function updateRadarChart(){
  const skillKeys = ['grammar','vocab','listening','speaking','writing','reading'];
  const sums = {grammar:0,vocab:0,listening:0,speaking:0,writing:0,reading:0};
  const counts = {grammar:0,vocab:0,listening:0,speaking:0,writing:0,reading:0};
  // aggregate across all materials
  Object.keys(state.materials).forEach(mid=>{
    const m = state.materials[mid];
    skillKeys.forEach(k=>{
      const v = m[k];
      if(v !== '' && v !== null && !isNaN(Number(v))){
        sums[k] += Number(v);
        counts[k] += 1;
      } else {
        // also try reading input field DOM (for new values before state sync)
        const el = document.querySelector(`.skillInput[data-mid="${mid}"][data-skill="${k}"]`);
        if(el && el.value !== ''){ sums[k] += Number(el.value); counts[k] += 1; state.materials[mid][k] = el.value; }
      }
    });
    // also sync score input value into state to keep everything consistent
    const scoreEl = document.querySelector(`.scoreInput[data-mid="${mid}"]`);
    if(scoreEl) state.materials[mid].score = scoreEl.value;
  });
  const avgArr = skillKeys.map(k => counts[k] ? (sums[k]/counts[k]).toFixed(2) : 0);
  radarChart.data.datasets[0].data = avgArr;
  radarChart.update();
}

/* ======================
   Initialization: set selected level to first, render default data, attach events
   ====================== */
selectLevel(0);
updateAllProgress();

/* attach events after initial generation (some attached earlier) */
attachMaterialEvents();

/* good practice: update progress on load & when any change */
document.addEventListener('input', ()=>updateAllProgress());
document.addEventListener('change', ()=>updateAllProgress());

/* final helper: expose some functions if user wants console manipulation */
window.__LLD = {
  levels, state, updateAllProgress, startLevelTimer, stopLevelTimer, selectLevel, updateRadarChart
};
</script>

</body>
</html>